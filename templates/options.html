<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TradePulse Options Intelligence</title>

    <meta http-equiv="refresh" content="10">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #f3f6fb, #ffffff);
            font-family: "Segoe UI", system-ui, sans-serif;
        }

        .header-box {
            background: linear-gradient(135deg, #673ab7, #9575cd);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        th { cursor: pointer; user-select: none; }

        .buy { background:#2e7d32;color:white;padding:5px 10px;border-radius:8px;font-weight:600; }
        .sell { background:#c62828;color:white;padding:5px 10px;border-radius:8px;font-weight:600; }
        .neutral { background:#607d8b;color:white;padding:5px 10px;border-radius:8px;font-weight:600; }

        .confidence { font-size:0.85rem; opacity:0.85; }

        /* üî• VOLUME BADGES */
        .volume-very-high { background:#6a1b9a;color:white;padding:4px 8px;border-radius:6px;font-weight:600; }
        .volume-high { background:#2e7d32;color:white;padding:4px 8px;border-radius:6px;font-weight:600; }
        .volume-medium { background:#f9a825;color:black;padding:4px 8px;border-radius:6px;font-weight:600; }
        .volume-low { background:#b0bec5;color:black;padding:4px 8px;border-radius:6px;font-weight:600; }
    </style>
</head>

<body>

<div class="container mt-4">

    <div class="header-box d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üß† TradePulse Options Intelligence</h4>
        <span>Last updated: {{ last_updated }}</span>
    </div>

    {% if error %}
        <div class="alert alert-danger text-center mt-3">
            {{ error }}
        </div>
    {% endif %}

    <!-- üîé FILTERS -->
    <div class="row g-2 mb-2">
        <div class="col-md-2">
            <select id="biasFilter" class="form-select">
                <option value="">All Bias</option>
                <option value="BUY">BUY</option>
                <option value="SELL">SELL</option>
                <option value="NEUTRAL">NEUTRAL</option>
            </select>
        </div>

        <div class="col-md-2">
            <select id="confidenceFilter" class="form-select">
                <option value="">All Confidence</option>
                <option value="HIGH">HIGH</option>
                <option value="MEDIUM">MEDIUM</option>
                <option value="LOW">LOW</option>
            </select>
        </div>

        <div class="col-md-2">
            <select id="ltpOrder" class="form-select">
                <option value="">LTP Order</option>
                <option value="ASC">LTP Ascending</option>
                <option value="DESC">LTP Descending</option>
            </select>
        </div>

        <div class="col-md-2"><input type="number" id="rankMin" class="form-control" placeholder="Rank Min"></div>
        <div class="col-md-2"><input type="number" id="rankMax" class="form-control" placeholder="Rank Max"></div>
    </div>

    <div class="mb-3 text-end">
        <button class="btn btn-outline-secondary btn-sm" onclick="resetAll()">üîÑ Reset All Filters</button>
    </div>

    <!-- üìä TABLE -->
    <div class="table-responsive mt-3">
        <table class="table table-bordered align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th onclick="sortTable(0)">Symbol ‚¨ç</th>
                    <th>LTP</th>
                    <th onclick="sortTable(2)">OI ‚¨ç</th>
                    <th onclick="sortTable(3)">Rank ‚¨ç</th>
                    <th>Volume</th>
                    <th onclick="sortTable(5)">Bias ‚¨ç</th>
                    <th onclick="sortConfidence()">Confidence ‚¨ç</th>
                    <th onclick="sortTable(7)">Reason ‚¨ç</th>
                    <th onclick="sortTable(8)">Context ‚¨ç</th>
                </tr>
            </thead>

            <tbody>
            {% for row in rows %}
                <tr>
                    <td><strong>{{ row.symbol }}</strong></td>
                    <td>{{ row.ltp }}</td>
                    <td>{{ row.openInterest }}</td>
                    <td>{{ row.rankScore }}</td>

                    <!-- üî• VOLUME SIGNAL -->
                    <td>
                        {% if row.volumeSignal == "VERY_HIGH" %}
                            <span class="volume-very-high">VERY HIGH</span>
                        {% elif row.volumeSignal == "HIGH" %}
                            <span class="volume-high">HIGH</span>
                        {% elif row.volumeSignal == "MEDIUM" %}
                            <span class="volume-medium">MEDIUM</span>
                        {% elif row.volumeSignal == "LOW" %}
                            <span class="volume-low">LOW</span>
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>

                    <td>
                        {% if row.bias == "BUY" %}
                            <span class="buy">BUY</span>
                        {% elif row.bias == "SELL" %}
                            <span class="sell">SELL</span>
                        {% else %}
                            <span class="neutral">NEUTRAL</span>
                        {% endif %}
                    </td>

                    <td class="confidence">{{ row.confidence }}</td>
                    <td>{{ row.reason }}</td>
                    <td>{{ row.context }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
let sortDir = {};
let lastSortCol = null;
const confidenceRank = { HIGH:3, MEDIUM:2, LOW:1 };

function saveState() {
    localStorage.setItem("tradepulse_state", JSON.stringify({
        bias: biasFilter.value,
        confidence: confidenceFilter.value,
        ltpOrder: ltpOrder.value,
        rankMin: rankMin.value,
        rankMax: rankMax.value,
        sortDir,
        lastSortCol
    }));
}

function restoreState() {
    const saved = localStorage.getItem("tradepulse_state");
    if (!saved) return;
    const s = JSON.parse(saved);

    biasFilter.value = s.bias || "";
    confidenceFilter.value = s.confidence || "";
    ltpOrder.value = s.ltpOrder || "";
    rankMin.value = s.rankMin || "";
    rankMax.value = s.rankMax || "";
    sortDir = s.sortDir || {};
    lastSortCol = s.lastSortCol;
}

function sortConfidence() {
    const tbody = document.querySelector("tbody");
    const rows = [...tbody.rows];
    lastSortCol = "confidence";

    rows.sort((a,b)=>
        confidenceRank[b.cells[6].innerText.trim()] -
        confidenceRank[a.cells[6].innerText.trim()]
    );

    rows.forEach(r=>tbody.appendChild(r));
    saveState();
}

function applyFilters() {
    let rows = [...document.querySelectorAll("tbody tr")];

    if (ltpOrder.value) {
        rows.sort((a,b)=>{
            let A = parseFloat(a.cells[1].innerText);
            let B = parseFloat(b.cells[1].innerText);
            return ltpOrder.value === "ASC" ? A - B : B - A;
        });
        rows.forEach(r=>r.parentNode.appendChild(r));
    }

    rows.forEach(row=>{
        let show=true;
        const bias=row.cells[5].innerText.trim();
        const conf=row.cells[6].innerText.trim();
        const rank=parseFloat(row.cells[3].innerText);

        if(biasFilter.value && bias!==biasFilter.value) show=false;
        if(confidenceFilter.value && conf!==confidenceFilter.value) show=false;
        if(rankMin.value && rank<rankMin.value) show=false;
        if(rankMax.value && rank>rankMax.value) show=false;

        row.style.display=show?"":"none";
    });

    saveState();
}

document.querySelectorAll("select, input")
    .forEach(el=>el.addEventListener("change",applyFilters));

function resetAll() {
    localStorage.removeItem("tradepulse_state");
    location.reload();
}

window.onload=()=>{
    restoreState();
    sortConfidence();
    applyFilters();
};
</script>

</body>
</html>
