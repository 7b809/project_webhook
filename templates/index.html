<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TradePulse Trade Dashboard</title>

    <!-- Auto refresh -->
    <meta http-equiv="refresh" content="5">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
            font-family: "Segoe UI", system-ui, sans-serif;
        }

        .header-box {
            background: linear-gradient(135deg, #0d6efd, #4dabf7);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(13,110,253,0.25);
        }

        .table-container {
            background: #ffffff;
            border-radius: 14px;
            padding: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        table thead th {
            background: linear-gradient(135deg, #0d6efd, #3f8cff);
            color: #ffffff;
            border: none;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        table tbody tr:hover {
            background-color: #f1f7ff;
        }

        .buy-badge {
            background: linear-gradient(135deg, #2e7d32, #66bb6a);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .sell-badge {
            background: linear-gradient(135deg, #c62828, #ef5350);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .empty-text {
            color: #90a4ae;
        }
    </style>
</head>

<body>

<div class="container mt-4">

    <div class="header-box d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">üìä TradePulse Trade Book</h4>
        <span>Last updated: {{ last_updated }}</span>
    </div>

    <div class="table-container">
        <div class="table-responsive">
            <table class="table align-middle text-center mb-0">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Ticker ‚¨ç</th>
                        <th onclick="sortTable(1)">Trade # ‚¨ç</th>
                        <th onclick="sortTable(2)">BUY Time ‚¨ç</th>
                        <th onclick="sortTable(3)">BUY Price ‚¨ç</th>
                        <th onclick="sortTable(4)">SELL Time ‚¨ç</th>
                        <th onclick="sortTable(5)">SELL Price ‚¨ç</th>
                    </tr>
                </thead>

                <tbody>
                {% for row in rows %}
                    <tr>
                        <td><strong>{{ row.ticker }}</strong></td>
                        <td>{{ row.serial }}</td>

                        <td>
                            {% if row.buy_time %}
                                <span class="buy-badge">üü¢ {{ row.buy_time }}</span>
                            {% else %}
                                <span class="empty-text">‚Äî</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if row.buy_price %}
                                <span class="buy-badge">üü¢ {{ row.buy_price }}</span>
                            {% else %}
                                <span class="empty-text">‚Äî</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if row.sell_time %}
                                <span class="sell-badge">üî¥ {{ row.sell_time }}</span>
                            {% else %}
                                <span class="empty-text">‚Äî</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if row.sell_price %}
                                <span class="sell-badge">üî¥ {{ row.sell_price }}</span>
                            {% else %}
                                <span class="empty-text">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if rows|length == 0 %}
        <div class="alert alert-info text-center mt-3">
            No trades received yet.
        </div>
    {% endif %}
</div>

<!-- ========================= -->
<!-- üîî TAB NOTIFICATION SCRIPT -->
<!-- ========================= -->
<script>
    const baseTitle = "TradePulse Trade Dashboard";
    const currentCount = {{ rows|length }};
    const lastCount = Number(localStorage.getItem("lastTradeCount") || 0);

    let unread = Number(localStorage.getItem("unreadTrades") || 0);

    if (currentCount > lastCount) {
        unread += (currentCount - lastCount);
        localStorage.setItem("unreadTrades", unread);
    }

    localStorage.setItem("lastTradeCount", currentCount);

    function updateTitle() {
        if (unread > 0 && document.hidden) {
            document.title = `(${unread}) ${baseTitle}`;
        } else {
            document.title = baseTitle;
        }
    }

    updateTitle();

    document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
            unread = 0;
            localStorage.setItem("unreadTrades", 0);
            document.title = baseTitle;
        }
    });
</script>

<!-- ========================= -->
<!-- üîÉ TABLE SORT SCRIPT -->
<!-- ========================= -->
<script>
    let sortDirection = {};

    function sortTable(colIndex) {
        const tbody = document.querySelector("table tbody");
        const rows = Array.from(tbody.rows);

        sortDirection[colIndex] = !sortDirection[colIndex];
        const asc = sortDirection[colIndex];

        rows.sort((a, b) => {
            let A = a.cells[colIndex].innerText.trim().replace(/[üü¢üî¥]/g, '');
            let B = b.cells[colIndex].innerText.trim().replace(/[üü¢üî¥]/g, '');

            if (A === "‚Äî") return 1;
            if (B === "‚Äî") return -1;

            if (!isNaN(A) && !isNaN(B)) {
                return asc ? A - B : B - A;
            }

            return asc ? A.localeCompare(B) : B.localeCompare(A);
        });

        rows.forEach(row => tbody.appendChild(row));
    }
</script>

</body>
</html>
